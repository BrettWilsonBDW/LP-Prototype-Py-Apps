<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Graphical Solver</title>
</head>

<style>
    html {
        background-color: #151617;
        color: white;
    }

    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }

    button {
        background-color: #20324d;
        color: white;
        border: none;
        /* border-radius: 5px; */
        padding: 2px 10px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        margin-right: 10px;
    }

    button:hover {
        background-color: #0056b3;
    }

    button:active {
        /* transform: scale(0.98); */
    }

    button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    input {
        width: 50px;
        margin-right: 5px;
        background-color: #212425;
        border: 1px solid #444;
        color: white;
        margin-left: 10px;
    }

    input[type="number"] {
        -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    select {
        margin-left: 5px;
        background-color: #212425;
        border: 1px solid #444;
        color: white;
    }

    .row {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
    }

    .cell {
        width: 80px;
        text-align: right;
        margin-right: 5px;
        box-sizing: border-box;
    }

    .highlight {
        color: greenyellow;
    }

    .header-row {
        font-weight: bold;
    }

    label {
        margin-right: 20px;
    }

    input[type="radio"] {
        margin-right: 5px;
    }

    p {
        font-weight: bold;
        color: white;
    }

    .constraint {
        margin-bottom: 10px;
    }

    .tableauContainer {
        margin-bottom: 20px;
        /* height: 300px; */
        overflow-y: auto;
        overflow-x: auto;
        width: 100%;
    }

    .tableauContainer .row {
        flex-wrap: nowrap;
    }

    .tableauContainer .cell {
        min-width: 80px;
    }

    #objectiveFunction,
    #constraintsContainer {
        margin-top: 20px;
    }
</style>

<body>
    <h1>Graphical Solver</h1>

    <h3 id="loadingStatus">Loading...</h3>

    <div hidden id="hiddenUntilLoad">
        <div>
            <label><input type="radio" name="problemType" value="Max" checked> Max</label>
            <label><input type="radio" name="problemType" value="Min"> Min</label>
        </div>

        <p id="problemTypeText">Problem is: Max</p>

        <div id="objectiveFunction" class="row"></div>

        <div class="row">
            <button id="addConstraint">Constraint +</button>
            <button id="removeConstraint">Constraint -</button>
        </div>

        <div id="constraintsContainer"></div>


        <div class="row">
            <button id="solveButton">Solve</button>
            <button id="resetButton" style="margin-left: 25px; background-color: red">Reset</button>
        </div>

    </div>

    <script>
        let problemType = "Max";
        let amtOfObjVars = 2;
        let amtOfConstraints = 1;
        let objFunc = [0.0, 0.0];
        let constraints = [[0.0, 0.0, 0.0, 0.0]];
        let signItems = ["<=", ">=", "="];
        let signItemsChoices = [0];

        function updateProblemType() {
            problemType = document.querySelector('input[name="problemType"]:checked').value;
            document.getElementById("problemTypeText").innerText = "Problem is: " + problemType;
        }

        function updateObjectiveFunction() {
            const objFuncContainer = document.getElementById("objectiveFunction");
            objFuncContainer.innerHTML = "";

            for (let i = 0; i < amtOfObjVars; i++) {
                const input = document.createElement("input");
                input.type = "number";
                input.value = objFunc[i];
                input.oninput = (e) => {
                    objFunc[i] = parseFloat(e.target.value);
                };

                const label = document.createElement("span");
                label.innerText = `x${i + 1}`;

                objFuncContainer.appendChild(input);
                objFuncContainer.appendChild(label);
            }
        }

        function updateConstraints() {
            const container = document.getElementById("constraintsContainer");
            container.innerHTML = "";

            for (let i = 0; i < amtOfConstraints; i++) {
                const constraintRow = document.createElement("div");
                constraintRow.className = "constraint";

                for (let j = 0; j < amtOfObjVars; j++) {
                    const input = document.createElement("input");
                    input.type = "number";
                    input.value = constraints[i][j];
                    input.oninput = (e) => {
                        constraints[i][j] = parseFloat(e.target.value);
                    };

                    const label = document.createElement("span");
                    label.innerText = `x${j + 1}`;

                    constraintRow.appendChild(input);
                    constraintRow.appendChild(label);
                }

                const signSelect = document.createElement("select");
                signItems.forEach((sign, index) => {
                    const option = document.createElement("option");
                    option.value = index;
                    option.innerText = sign;
                    signSelect.appendChild(option);
                });
                signSelect.value = signItemsChoices[i];
                signSelect.onchange = (e) => {
                    signItemsChoices[i] = parseInt(e.target.value);
                    constraints[i][amtOfObjVars + 1] = signItemsChoices[i];
                };

                const rhsInput = document.createElement("input");
                rhsInput.type = "number";
                rhsInput.value = constraints[i][amtOfObjVars];
                rhsInput.oninput = (e) => {
                    constraints[i][amtOfObjVars] = parseFloat(e.target.value);
                };

                constraintRow.appendChild(signSelect);
                constraintRow.appendChild(rhsInput);

                container.appendChild(constraintRow);
            }
        }

        document.querySelectorAll('input[name="problemType"]').forEach(radio => {
            radio.onchange = updateProblemType;
        });

        document.getElementById("addConstraint").onclick = () => {
            amtOfConstraints++;
            const newConstraint = new Array(amtOfObjVars).fill(0.0);
            newConstraint.push(0.0);  // for sign
            newConstraint.push(0.0);  // for rhs
            constraints.push(newConstraint);
            signItemsChoices.push(0);
            updateConstraints();
        };

        document.getElementById("removeConstraint").onclick = () => {
            if (amtOfConstraints > 1) {
                amtOfConstraints--;
                constraints.pop();
                signItemsChoices.pop();
                updateConstraints();
            }
        };

        function resetRadios() {
            document.querySelector('input[value="Max"]').checked = true;
        }

        document.getElementById("resetButton").onclick = () => {
            problemType = "Max";
            amtOfObjVars = 2;
            amtOfConstraints = 1;
            objFunc = [0.0, 0.0];
            constraints = [[0.0, 0.0, 0.0, 0.0]];
            signItems = ["<=", ">=", "="];
            signItemsChoices = [0];

            updateObjectiveFunction();
            updateConstraints();
            resetRadios();
        };

        function getObjFunc() {
            return objFunc;
        }

        function getConstraints() {
            return constraints;
        }

        function getProblemType() {
            return problemType;
        }

        // Initial render
        updateObjectiveFunction();
        updateConstraints();
        resetRadios();
    </script>

    <py-config>
        packages = [
        "matplotlib"
        ]
        [[fetch]]
        files = ["./graphicalsolver.py"]
    </py-config>

    <script type="py">
        from pyscript import document, display, when
        from js import console, getObjFunc, getConstraints, getProblemType
        import copy

        document.getElementById("hiddenUntilLoad").removeAttribute("hidden");
        document.getElementById("loadingStatus").hidden = True;
        
        import matplotlib.pyplot as plt
        import matplotlib.tri as tri
        import numpy as np
        
        from graphicalsolver import GraphicalSolver

        console.clear();

        # Initialize object
        graphicalSolver = GraphicalSolver()


        def renderGraph():
            for elem in document.querySelectorAll('[id^="matplotlib_"]'):
                elem.remove()

            plt.clf()

            if getProblemType() == "Max":
                isMin = False
            else:
                isMin = True

            try:
                graphicalSolver.feasiblePoints, graphicalSolver.lineSegmentPoints, graphicalSolver.intersectionPoints = graphicalSolver.getSortedPoints(
                    graphicalSolver.constraints)

                graphicalSolver.optimalValue, graphicalSolver.optimalPoint = graphicalSolver.solveGraphical(
                    graphicalSolver.objFunc, graphicalSolver.feasiblePoints, isMin)

                graphicalSolver.drawGraph(graphicalSolver.feasiblePoints, graphicalSolver.lineSegmentPoints,
                    graphicalSolver.intersectionPoints, graphicalSolver.optimalPoint, graphicalSolver.optimalValue)
            except Exception as e:
                raise

        def renderOutput():
            renderGraph()

        @when("click", "#solveButton")
        def solve(event):
            try:
                graphicalSolver.reset()
                for elem in document.querySelectorAll('.error'):
                    elem.remove()

                objFunc = getObjFunc().to_py()

                constraints = getConstraints().to_py()

                if getProblemType() == "Max":
                    isMin = False
                else:
                    isMin = True

                # Copy and compute
                a = copy.deepcopy(objFunc)
                b = copy.deepcopy(constraints)
                    
                graphicalSolver.objFunc = a
                graphicalSolver.constraints = b
                
                renderOutput()
            except Exception as e:
                for elem in document.querySelectorAll('.error'):
                    elem.remove()
                errorDiv = document.createElement('div')
                errorDiv.className = 'error'
                errorDiv.textContent = "Math Error"
                document.body.appendChild(errorDiv)

                raise

        @when("click", "#resetButton")
        def reset(event):
            graphicalSolver.reset()
            # Remove existing tableaus
            for elem in document.querySelectorAll('[id^="matplotlib_"]'):
                elem.remove()
            for elem in document.querySelectorAll('.error'):
                elem.remove()
            
    </script>
</body>

</html>