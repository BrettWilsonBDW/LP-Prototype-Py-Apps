<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <title>Linier Programming Duality</title>
    <style>
        html {
            background-color: #151617;
            color: white;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        button {
            background-color: #20324d;
            color: white;
            border: none;
            /* border-radius: 5px; */
            padding: 2px 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-right: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:active {
            /* transform: scale(0.98); */
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        input {
            width: 50px;
            margin-right: 5px;
            background-color: #212425;
            border: 1px solid #444;
            color: white;
            margin-left: 10px;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        select {
            margin-left: 5px;
            background-color: #212425;
            border: 1px solid #444;
            color: white;
        }

        .row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .cell {
            width: 80px;
            text-align: right;
            margin-right: 5px;
            box-sizing: border-box;
        }

        .highlight {
            color: greenyellow;
        }

        .header-row {
            font-weight: bold;
        }

        label {
            margin-right: 20px;
        }

        input[type="radio"] {
            margin-right: 5px;
        }

        p {
            font-weight: bold;
            color: white;
        }

        .constraint {
            margin-bottom: 10px;
        }

        .tableauContainer {
            margin-bottom: 20px;
            /* height: 300px; */
            overflow-y: auto;
            overflow-x: auto;
            width: 100%;
        }

        .tableauContainer .row {
            flex-wrap: nowrap;
        }

        .tableauContainer .cell {
            min-width: 80px;
        }

        #objectiveFunction,
        #constraintsContainer {
            margin-top: 20px;
        }

        .highlight {
            color: cyan;
        }
        .objective-function {
            color: greenyellow;
        }
        .slack-highlight {
            color: magenta;
        }
        .opt-highlight {
            color: yellow;
        }
    </style>
</head>

<body>
    <h1>Linier Programming Duality</h1>

    <h3 id="loadingStatus">Loading...</h3>

    <div hidden id="hiddenUntilLoad">
        <div>
            <label><input type="radio" name="problemType" value="Max" checked> Max</label>
            <label><input type="radio" name="problemType" value="Min"> Min</label>
        </div>

        <p id="problemTypeText">Problem is: Max</p>

        <div class="row">
            <button id="addDecisionVar">decision variables +</button>
            <button id="removeDecisionVar">decision variables -</button>
        </div>

        <div id="objectiveFunction" class="row"></div>

        <div class="row">
            <button id="addConstraint">Constraint +</button>
            <button id="removeConstraint">Constraint -</button>
        </div>

        <div id="constraintsContainer"></div>


        <div class="row">
            <button id="solveButton">Solve</button>
            <button id="resetButton" style="margin-left: 25px; background-color: red">Reset</button>
        </div>

        <br>
        <div id="tableauContainer"></div>

    </div>

    <script>
        let problemType = "Max";
        let amtOfObjVars = 2;
        let amtOfConstraints = 1;
        let objFunc = [0.0, 0.0];
        let constraints = [[0.0, 0.0, 0.0, 0.0]];
        let signItems = ["<=", ">="];
        let signItemsChoices = [0];

        function updateProblemType() {
            problemType = document.querySelector('input[name="problemType"]:checked').value;
            document.getElementById("problemTypeText").innerText = "Problem is: " + problemType;
        }

        function updateObjectiveFunction() {
            const objFuncContainer = document.getElementById("objectiveFunction");
            objFuncContainer.innerHTML = "";

            for (let i = 0; i < amtOfObjVars; i++) {
                const input = document.createElement("input");
                input.type = "number";
                input.value = objFunc[i];
                input.oninput = (e) => {
                    objFunc[i] = parseFloat(e.target.value);
                };

                const label = document.createElement("span");
                label.innerText = `x${i + 1}`;

                objFuncContainer.appendChild(input);
                objFuncContainer.appendChild(label);
            }
        }

        function updateConstraints() {
            const container = document.getElementById("constraintsContainer");
            container.innerHTML = "";

            for (let i = 0; i < amtOfConstraints; i++) {
                const constraintRow = document.createElement("div");
                constraintRow.className = "constraint";

                for (let j = 0; j < amtOfObjVars; j++) {
                    const input = document.createElement("input");
                    input.type = "number";
                    input.value = constraints[i][j];
                    input.oninput = (e) => {
                        constraints[i][j] = parseFloat(e.target.value);
                    };

                    const label = document.createElement("span");
                    label.innerText = `x${j + 1}`;

                    constraintRow.appendChild(input);
                    constraintRow.appendChild(label);
                }

                const signSelect = document.createElement("select");
                signItems.forEach((sign, index) => {
                    const option = document.createElement("option");
                    option.value = index;
                    option.innerText = sign;
                    signSelect.appendChild(option);
                });
                signSelect.value = signItemsChoices[i];
                signSelect.onchange = (e) => {
                    signItemsChoices[i] = parseInt(e.target.value);
                    constraints[i][amtOfObjVars + 1] = signItemsChoices[i];
                };

                const rhsInput = document.createElement("input");
                rhsInput.type = "number";
                rhsInput.value = constraints[i][amtOfObjVars];
                rhsInput.oninput = (e) => {
                    constraints[i][amtOfObjVars] = parseFloat(e.target.value);
                };

                constraintRow.appendChild(signSelect);
                constraintRow.appendChild(rhsInput);

                container.appendChild(constraintRow);
            }
        }

        document.querySelectorAll('input[name="problemType"]').forEach(radio => {
            radio.onchange = updateProblemType;
        });

        document.getElementById("addDecisionVar").onclick = () => {
            amtOfObjVars++;
            objFunc.push(0.0);
            constraints.forEach(constraint => constraint.splice(amtOfObjVars - 1, 0, 0.0));
            updateObjectiveFunction();
            updateConstraints();
        };

        document.getElementById("removeDecisionVar").onclick = () => {
            if (amtOfObjVars > 2) {
                amtOfObjVars--;
                objFunc.pop();
                constraints.forEach(constraint => constraint.splice(amtOfObjVars, 1));
                updateObjectiveFunction();
                updateConstraints();
            }
        };

        document.getElementById("addConstraint").onclick = () => {
            amtOfConstraints++;
            const newConstraint = new Array(amtOfObjVars).fill(0.0);
            newConstraint.push(0.0);  // for sign
            newConstraint.push(0.0);  // for rhs
            constraints.push(newConstraint);
            signItemsChoices.push(0);
            updateConstraints();
        };

        document.getElementById("removeConstraint").onclick = () => {
            if (amtOfConstraints > 1) {
                amtOfConstraints--;
                constraints.pop();
                signItemsChoices.pop();
                updateConstraints();
            }
        };

        function resetRadios() {
            document.querySelector('input[value="Max"]').checked = true;
        }

        document.getElementById("resetButton").onclick = () => {
            problemType = "Max";
            amtOfObjVars = 2;
            amtOfConstraints = 1;
            objFunc = [0.0, 0.0];
            constraints = [[0.0, 0.0, 0.0, 0.0]];
            signItems = ["<=", ">="];
            signItemsChoices = [0];

            updateObjectiveFunction();
            updateConstraints();
            resetRadios();
        };

        function getObjFunc() {
            return objFunc;
        }

        function getConstraints() {
            return constraints;
        }

        function getProblemType() {
            return problemType;
        }

        // Initial render
        updateObjectiveFunction();
        updateConstraints();
        resetRadios();
    </script>

    <py-config>
        packages = [
        ]
        [[fetch]]
        files = [
        "./lpduality.py",
        "../dual/dualsimplex.py",
        ]
    </py-config>
    <script type="py">
        from pyscript import document, display, when
        from js import console, getObjFunc, getConstraints, getProblemType
        import copy
    
        document.getElementById("hiddenUntilLoad").removeAttribute("hidden");
        document.getElementById("loadingStatus").hidden = True;
        
        from lpduality import LPDuality

        console.clear();
        
        # Initialize object
        lPDuality = LPDuality()

        def renderTableau():
            for elem in document.querySelectorAll('.tableauContainer'):
                elem.remove()

            container = document.createElement('div')
            container.className = 'tableauContainer'

            try:
                # Example data; replace with actual data
                headerString = lPDuality.headerString
                tObjFunc = lPDuality.tObjFunc
                constraintsLhs = lPDuality.constraintsLhs
                cellRef = lPDuality.cellRef
                constraints = lPDuality.constraints
                changingVars = lPDuality.changingVars
                strDualMin = lPDuality.strDualMin

                dualHeaderString = lPDuality.dualHeaderString
                tDualObjFunc = lPDuality.tDualObjFunc
                dualConstraintsLhs = lPDuality.dualConstraintsLhs
                dualCellRef = lPDuality.dualCellRef
                dualConstraints = lPDuality.dualConstraints
                dualChangingVars = lPDuality.dualChangingVars
                strMin = lPDuality.strMin

                # Header Strings
                headerRow = document.createElement('div')
                headerRow.className = 'row'
                for h in headerString:
                    headerCell = document.createElement('div')
                    headerCell.className = 'cell header-cell'
                    headerCell.textContent = h
                    headerRow.appendChild(headerCell)
                container.appendChild(headerRow)

                # Objective Function
                objectiveRow = document.createElement('div')
                objectiveRow.className = 'row'
                objectiveLabel = document.createElement('div')
                objectiveLabel.className = 'cell'
                objectiveLabel.textContent = f"{strDualMin} z"
                objectiveRow.appendChild(objectiveLabel)

                for i, value in enumerate(tObjFunc):
                    valueCell = document.createElement('div')
                    valueCell.className = f'cell {"highlight" if i != len(tObjFunc) - 1 else "objective-function"}'
                    valueCell.textContent = f"{value:.3f}"
                    objectiveRow.appendChild(valueCell)
                container.appendChild(objectiveRow)

                displayCons = copy.deepcopy(constraintsLhs)

                # Build display constraints
                for i in range(len(constraintsLhs)):
                    displayCons[i].append(cellRef[i])
                    displayCons[i].append("<=" if constraints[i][-1] == 0 else ">=")
                    displayCons[i].append(constraints[i][-2])
                    tSlack = displayCons[i][-1] - displayCons[i][-3]
                    displayCons[i].append(tSlack)

                # Display the Constraints
                for i, cons in enumerate(displayCons):
                    consRow = document.createElement('div')
                    consRow.className = 'row'

                    rowLabel = document.createElement('div')
                    rowLabel.className = 'cell header-cell'
                    rowLabel.textContent = f"c{i + 1}"
                    consRow.appendChild(rowLabel)

                    for j, value in enumerate(cons):
                        valueCell = document.createElement('div')
                        valueCell.className = f'cell {"slack-highlight" if j == len(cons) - 2 else ""}'
                        valueCell.textContent = f"{value:.3f}" if isinstance(value, float) else f"{value}"
                        consRow.appendChild(valueCell)
                    container.appendChild(consRow)

                # Optimal Values
                optRow = document.createElement('div')
                optRow.className = 'row'

                optLabel = document.createElement('div')
                optLabel.className = 'cell header-cell'
                optLabel.textContent = "opt"
                optRow.appendChild(optLabel)

                for value in changingVars:
                    valueCell = document.createElement('div')
                    valueCell.className = 'cell opt-highlight'
                    valueCell.textContent = f"{value:.3f}"
                    optRow.appendChild(valueCell)
                container.appendChild(optRow)

                # Separator
                separator = document.createElement('hr')
                container.appendChild(separator)

                # Dual Header Strings
                dualHeaderRow = document.createElement('div')
                dualHeaderRow.className = 'row'
                for h in dualHeaderString:
                    dualHeaderCell = document.createElement('div')
                    dualHeaderCell.className = 'cell header-cell'
                    dualHeaderCell.textContent = h
                    dualHeaderRow.appendChild(dualHeaderCell)
                container.appendChild(dualHeaderRow)

                # Dual Objective Function
                dualObjectiveRow = document.createElement('div')
                dualObjectiveRow.className = 'row'
                dualObjectiveLabel = document.createElement('div')
                dualObjectiveLabel.className = 'cell'
                dualObjectiveLabel.textContent = f"{strMin} z"
                dualObjectiveRow.appendChild(dualObjectiveLabel)

                for i, value in enumerate(tDualObjFunc):
                    valueCell = document.createElement('div')
                    valueCell.className = f'cell {"slack-highlight" if i != len(tDualObjFunc) - 1 else "objective-function"}'
                    valueCell.textContent = f"{value:.3f}"
                    dualObjectiveRow.appendChild(valueCell)
                container.appendChild(dualObjectiveRow)

                dualDisplayCons = copy.deepcopy(dualConstraintsLhs)

                # Build dual display constraints
                for i in range(len(dualConstraintsLhs)):
                    dualDisplayCons[i].append(dualCellRef[i])
                    dualDisplayCons[i].append(">=" if dualConstraints[i][-1] == 0 else "<=")
                    dualDisplayCons[i].append(tDualObjFunc[i])
                    tSlack = dualDisplayCons[i][-1] - dualDisplayCons[i][-3]
                    dualDisplayCons[i].append(tSlack)

                # Display the Dual Constraints
                for i, cons in enumerate(dualDisplayCons):
                    dualConsRow = document.createElement('div')
                    dualConsRow.className = 'row'

                    rowLabel = document.createElement('div')
                    rowLabel.className = 'cell header-cell'
                    rowLabel.textContent = f"c{i + 1}"
                    dualConsRow.appendChild(rowLabel)

                    for j, value in enumerate(cons):
                        valueCell = document.createElement('div')
                        valueCell.className = f'cell {"highlight" if j == len(cons) - 2 else ""}'
                        valueCell.textContent = f"{value:.3f}" if isinstance(value, float) else f"{value}"
                        dualConsRow.appendChild(valueCell)
                    container.appendChild(dualConsRow)

                # Dual Optimal Values
                dualOptRow = document.createElement('div')
                dualOptRow.className = 'row'

                dualOptLabel = document.createElement('div')
                dualOptLabel.className = 'cell header-cell'
                dualOptLabel.textContent = "opt"
                dualOptRow.appendChild(dualOptLabel)

                for value in dualChangingVars:
                    valueCell = document.createElement('div')
                    valueCell.className = 'cell opt-highlight'
                    valueCell.textContent = f"{value:.3f}"
                    dualOptRow.appendChild(valueCell)
                container.appendChild(dualOptRow)

                document.body.appendChild(container)

            except Exception as e:
                errorText = document.createElement('p')
                errorText.textContent = "Error in rendering tableau"
                container.appendChild(errorText)

        @when("click", "#solveButton")
        def solve(event):
            try:
                lPDuality.reset()
                # lPDuality.objFunc, lPDuality.constraints, isMin = lPDuality.testInput(0)

                objFunc = getObjFunc().to_py()

                constraints = getConstraints().to_py()

                if getProblemType() == "Max":
                    isMin = False
                else:
                    isMin = True

                lPDuality.objFunc = objFunc 
                lPDuality.constraints = constraints

                lPDuality.headerString.clear()
                lPDuality.dualHeaderString.clear()

                a = copy.deepcopy(lPDuality.objFunc)
                b = copy.deepcopy(lPDuality.constraints)
                lPDuality.objFunc, lPDuality.optimalSolution, lPDuality.changingVars, lPDuality.constraintsLhs, lPDuality.cellRef, lPDuality.dualObjFunc, lPDuality.dualOptimalSolution, lPDuality.dualChangingVars, lPDuality.dualConstraintsLhs, lPDuality.dualCellRef = lPDuality.doDuality(
                    a, b, isMin)

                # for display reasons
                lPDuality.tObjFunc = copy.deepcopy(lPDuality.objFunc)
                lPDuality.tDualObjFunc = copy.deepcopy(lPDuality.dualObjFunc)
                lPDuality.tObjFunc.append(lPDuality.optimalSolution)
                lPDuality.tDualObjFunc.append(lPDuality.dualOptimalSolution)

                dualMin = not isMin

                if isMin:
                    lPDuality.strMin = "max"
                else:
                    lPDuality.strMin = "min"

                if dualMin:
                    lPDuality.strDualMin = "max"
                else:
                    lPDuality.strDualMin = "min"

                lPDuality.headerString.append("Primal")
                lPDuality.dualHeaderString.append("Dual")

                for i in range(len(lPDuality.objFunc)):
                    lPDuality.headerString.append("x{}".format(i + 1))

                for i in range(len(lPDuality.dualObjFunc)):
                    lPDuality.dualHeaderString.append("y{}".format(i + 1))

                lPDuality.headerString.append("Ref")
                lPDuality.headerString.append("Sign")
                lPDuality.headerString.append("Rhs")
                lPDuality.headerString.append("Slack")

                lPDuality.dualHeaderString.append("Ref")
                lPDuality.dualHeaderString.append("Sign")
                lPDuality.dualHeaderString.append("Rhs")
                lPDuality.dualHeaderString.append("Slack")

                renderTableau()

            except Exception as e:
                for elem in document.querySelectorAll('.error'):
                    elem.remove()
                errorDiv = document.createElement('div')
                errorDiv.className = 'error'
                errorDiv.textContent = "Math Error"
                document.body.appendChild(errorDiv)

        @when("click", "#resetButton")
        def reset(event):
            lPDuality.reset()
            # Remove existing tableaus
            for elem in document.querySelectorAll('.tableauContainer'):
                elem.remove()
            for elem in document.querySelectorAll('.error'):
                elem.remove()

    </script>

</body>

</html>